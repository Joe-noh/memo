# ペパボテックカンファレンス

2015/04/19(日)。セルリアン11Fにて。

## Nyah - ポチポチするためにニャーニャーしよう

by ボブさん

### Nyahとは

ペパボの仮想インフラ基盤(Iaas)。

- クラウド化で
  - リソース利用の効率化
  - サーバの集約
  - コスト削減

### れきし

OpenStackやるぞ！！！！１

Packstack(Redhat系でopenstackできる)を検証。
むずい。詳しい人に突撃。やっぱOpenStackむずい
秋ごろにConoHaの実績をベースに構築。
2015年春にGH:Eを移行。

### 仕様

OpenStack全乗っけではないが、VMの管理が簡単に

### 今後

- インフラ一元管理
- ベアメタル
- hashicorpプロダクトと共に

## Consulは全自動オーケストレーションの夢を見るか？

by うずらさん(DevOps'er 自動化厨)

### Cunsul

- サービスディスカバリ
- ヘルスチェック
- KVS
- 複数データセンタ対応

### Raft Consensus Algorithm

全ノードで矛盾が出ないように調整するアルゴリズム。
リーダーを投票で決める。

### ハマった点

- 実行ユーザは`consul`
- サーバは3台以上
- 基本はサーバモードで立ち上げる
  - 運用の都合上増減するものはクライアントモード
- `GOMAXPROCS`はCPU数と揃える
- `vm.overcommit_memory=0`

### Programmable Consul

- `consul watch`コマンド
  - イベント監視のためのコマンド
  - "nginxが落ちた！"とか
  - 特定のコマンドにJSONを渡せる
  - Slackへの通知も
- 動的ロードバランサという夢
  - nginxなどの設定を動的に書き換えるなど
  - `consul-template`

### populus

DSL for consul

- gem
- specinfraでリモートコマンドを発行
- まだいろいろ足らない
  - watchできる対象とか

### まとめ

consulはnagiosの代替ではない。Nyahと組み合わせると最強っぽい

## AngularJSの継続的バージョンアップ

by つちかずさん

カラーミーのショッピングカート画面リニューアルプロジェクト。

### AngularJS

今の最新はv1.3。来年には2.0でる？

### バージョン上げる？

> 止まっているのはそれだけでバグを生んでいるのと一緒

### 継続的バージョンアップには

#### 次期バージョンを見据える

- NewRouter
  - 1系と2系を共存させられる。このページは1.4で〜みたいな
  - 今後はmigration機能も
- Tips
  - これから書く人はTypeScript
    - ES5で書いている人はES6
    - coffeeはちょっとやめたほうがいいかも
  - Serviceは単なるクラスへ
  - scopeが無くなるので
    - Directiveでは`controller as`を使う

#### テスト

テストに正解はない。

- Controller, Service, DirectiveのUnitテスト
  - 不安解消、分岐網羅のため
  - Jasmine & Karma
  - F/W側の構成が大きく変わると無意味になっちゃう
- E2Eテスト
  - Angular + API + ほか全て
  - めっちゃコスト高い
  - 手動テストしてる
- E2E with API Mock
  - フロントだけをテスト
  - Protoractor & ngMockE2E
  - Mockと本番APIが一致しない状態も有りえる
    - Mockのテスト

#### 他の技術のキャッチアップ

がんばろう。

## ECサービスの負荷テスト

by おいちゃんさん

### 事の発端

アクセス増えた。大型ショップのタイムセールだった。
MySQLが悲鳴をあげる。

- 再発防止策
  - エラー原因の特定
  - ボトルネック特定
  - 目標値設定
    - 秒間20購入(仮)に耐えられるように
  - ロジックの改善
  - 効果測定(負荷テスト)

### 準備

- 環境どうする？
  - 本番と同じ環境を用意するのはお金かかる
  - じゃあ本番で！
    - アクセスが少ない時間帯に
    - 閾値を超えたらテスト中止
      - ApacheのBusyServers数
      - MySQLマスターDBの接続数
- ツール
  - Gatling
    - Scala製
    - テストシナリオをコードで書ける
    - ブラウザ操作の記録もできる

### 実施

#### 1回目

- 同時購入ユーザを上げてった
  - 秒間10購入できないと仮定
  - 秒間40購入できてしまった。は？

#### 2回目

- 5分間の購入ユーザを上げていった。
  - 「5分間で1500ユーザ」のテストに時間がかかり中止

#### 3回目

改善後のテスト

- 5分間の購入ユーザを上げていった。
  - 「5分間で3800ユーザ」のテスト中に閾値を超えたので中止

## おから(仮) - ngx\_small\_lightとngx\_mrubyでつくる動的画像変換

by やのさん

### 動的画像変換

- 従来型
  - アップロード後にS/M/Lなどのパターンをつくる
- 動的
  - アップロード後は変換しない
  - リクエスト時にリサイズして返す
  - 同サイズはキャッシュしとく

### 動的画像変換導入のメリット

- デザインの自由度アップ
  - サムネイルとか、もうちょっと小さくしたい〜
- 新デバイス対応しやすい
- 適正な転送量
  - 負荷、お金の削減
  - ユーザビリティ向上

### おから(仮)

- リクエスト
  - 幅x高さ
  - 謎のハッシュ

- `nginx_small_light` + `ngx_mruby`
  - dynamic image transformation module
  - URLの仕様変えたい
    - 受ける→mrubyで変換→nginx\_small\_lightに渡す
  - 適正なリクエストだけ処理したい
    - mrubyで秘密の文字列を素にしたのハッシュ値をチェック

## BitCoinとRippleの共存について

by わっかむさん

### BitCoin

#### 特徴

- ネット上でやりとりされる、価値をもったデータ
- 2100万Bitcoinが総量
- 法定通貨に対して価格変動する
- P2Pである
- 決済の送金手数料が安い(0円から数円)
- 決済・送金完了までの時間がかかる(約10分)

### Ripple

法定通貨や仮想通貨をはじめ、あらゆる価値に相当するデータの交換・送受信・取引をするためのプラットフォーム・

通貨をRippleネットワークで表現したものがIOU。
RippleネットワークとJPYやBitcoinのネットワークの間に立って交換するのがGateway。

- XRP
  - Ripple上の取引で消費される
  - XRP同士の交換もできる

#### 特徴

- 決済の送金手数料が安い
- 決済・送金完了までの時間が短い
- GatewayがIOUとJPYの交換に応じない場合もある

## 最近WebGLを勉強し始めた話

by いもっちさん

### WebGL

3Dコンピュータ・グラフィックスを表示する標準仕様

- 仮想的な3次元空間をシミュレートする
- どこをスクリーンに表示するか、カメラの位置を決める
- プロジェクション変換して2次元空間に落としこむ
- 描画APIとしてのOpenGL

#### つらいこと

- シェーダに値を渡すのが煩雑
- 数学の知識がかなり必要

### 社内勉強会の話

- メンバー5,6人
- 週3でお昼に
- issueにログを残す
- ひとりじゃないので心が折れない
- 昼休みがやりやすい
- ゆるく
- 互いの得意領域で補完できる

#### 大変なこと

- 詰まったときに解決できない
- なるほど〜からの応用がわからん

#### 今後

- 社内人口を増やす
- ゆっくりでもやり続ける
- 実務で使いたい
  - まずはペライチからでも
  - キャッチーでシュッとした感じ

## 見積りと計画づくりの技術

by けんちゃんくさん

### 見積りと計画づくりの目的

> コードの読み書きと見積り(ソロバン)ができて一人前

- 問題領域の理解
- 自分の実力の理解
- 見積りの正解とは？
  - 実時間とあっていればいいのか？
  - 計画通りに進んでいたら正解？

図2つ

- 不確実性コーン
- 見積りの正確性と労力
  - 正確性100%は無理
  - 労力をかけすぎると正確性が落ちる

見積りの主体はだれか、なんのための見積りかを明確にして必要十分な見積りを。

- 労力と正確性
- 粒度

### 見積りと計画づくりの技術

#### 見積り対象

- ユーザストーリー
  - 独立性
    - 依存関係をなくすのは難しい。
    - 見積りのスケールが合わないことも。
    - 可視化して高める
    - トレードオフになったらスケールが合うことを優先する。
  - 交渉可能
    - 工夫の余地がある
    - 実装方法の先入観をなくす
  - 価値がある
    - POにデモすることを想定する
    - ビジネスとエンジニアリングの間

#### 見積りの実施

- 相対規模見積り
  - フィボナッチ数列で考える
  - 大中小の3つで分類する
  - 人間は相対的な比較が得意(要出典)
- ストーリーの分割
  - ストーリーをストーリーに分割
  - ストーリーをタスクに分割する
    - DONEを定義し直す。完了条件を明確にする
    - ストーリーを完了するタスクを作る
- 規模見積りと時間見積りのMIX
  - 相対比較しにくいタスク
  - 単位の相互変換は不幸を生む
  - スプリントプランニングで調整

#### 見積りと計画づくり

- 計画づくりは計画ではない
  - チームがプロダクトを理解するための活動
  - 計画づくりの成果物のひとつが計画
- 妥当なコストで計画づくりをし続ける
- PivotalTracker
  - 計画の自動修正
  - チームの力の一時的増減を可視化できる
  - やることを一列に並べることを強制できる

## 私の半生

by なかじさん

### エンジニアのタイプ

- 書くまでのプロセスが好きな人
  - テスト
  - フレームワーク
  - 自動化
- ものをつくるのが好きな人
  - とにかく書きたい

### プロダクトドリブン

あんなことできたらいいなから始まる。
知識や経験の蓄積→技術の抽象化。

- 成長サイクル
  1. ほしい
  2. つくる
  3. やりきる
  4. 振り返る

### 制作物

- frustration.me
- おわかりいただけただろうか
- 中島清掃局
- もう一度ご覧いただこう
- NKJMovieComposer
- NKJMultiMOvieCaptureView
- Limu
- teiten

### どうなるか

- 手段が目的になるの上等
- 手を動かさないと始まらない
- 強い覚悟と決断が身につく
- やりきった先に快感
- プロダクトに愛が生まれる
- 満たされる
- 知識や技術が整理される

## hubotを用いたChatOps入門

by じっぱーさん

### hubot

- Script
  - npmの`hubot-script`タグ
  - 自作するときはファイル先頭に決まったフォーマットでコメントを記述
- Robot
- Brain
  - redis backend
  - file backend
- Adapter
  - chatの数だけadapterが

### 例

- nagiosのURLを返す
- muninのURLを返す
- 定期的に通知(`node-cron`)
- webistranoでデプロイ

## MySQLを4.0から5.0を経由して5.6へバージョンアップした話

by ボイラーさん

### 規模感

- slave10台
- 600GB
- DBを見ているロール7個

### メンバー

- 主に2人

### 4.0のデータを5.6に突っ込む

- スクリプトかましてSQLを修正
- 開発環境を5.6に
  - 社内で布教
- 不要なレコードを削除

### 流れ

- 5.0をmasterのレプリケーションに設定
  - INSERT, UPDATEがエラーにならないかチェック
- 5.0をslave(一部)に設定
- slave全部5.0に
- これを5.0→5.6でもう一周

### 注意

- 移行途中にmasterにSQLを流すときは最新バージョンで検証
  - masterでOK、slaveでNG→レプリケーションが止まる

